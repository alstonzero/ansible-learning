# 常用模块

## Andible Ad-Hoc 命令
Ad-hoc命令是什么呢？这其实是一个概念性的名字，是相当于写Ansible playbook来说的。类似于在命令行敲入shell命令和写shell scripts两者之间的关系。可以用于执行一些临时命令。前者可以解决一些简单的任务，后者解决较复杂的任务，比如做配置管理或部署。

命令语法格式：
`ansible pattern -i inventory.yml -m moudle -a argument`
- `pattern`资产选择器,比如`all`
- `-i`指定资产清单文件的位置
- `-m`指定本次`ad-hoc`要执行的模块。可以类别成shell中的命令。
- `-a`模块的参数。可以类比成shell中的参数。

## 4.常用模块
### 4.1command&shell模块
两个模块都是在远程服务器上去执行命令。
但command模块是ad-hoc的默认模块，在执行ad-hoc时，若不指定模块的名字则默认使用此模块
```
ansible all -i inventory.yml -m command -a "echo 'hello'"
```
```
ansbile all -i inventory.yml -a "echo 'hello'"
```
- 使用shell
```
ansible all -i inventory.yml -m shell -a "ls -l /tmp"
```

#### 两个模块的差异
- shell 模块可以执行shell的内置命令和特性（比如管道符）。
- command模块无法执行shell的内置命令和特性

### 4.2script 模块
将管理节点上的脚本传递到被管理节点（远程服务器）上进行执行，理论上此模块的执行完全不需要被管理服务器上有Python。
#### Example
管理节点上的一个脚本 /root/a.sh
```
ansible all -i inventory.yml -m script -a "/root/a.sh"
```
### 4.3 copy模块
copy模块的主要作用于管理节点和被管理节点之间的文件拷贝。
经常使用到的参数如下：
- src 指定拷贝文件的源地址
- dest 指定拷贝文件的目标地质
- backup 拷贝文件前，若原始文件发生变化，则对目标文件进行备份
- woner 指定新拷贝文件的所有者
- group 指定新拷贝文件的所有组
- mode 执行新拷贝文件的权限

#### Example
- copy管理节点的nginx.repo(当前目录下)到被管理节点上
http://nginx.org/en/linux_packages.html
```
#cat nignx.repo
[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true

[nginx-mainline]
name=nginx mainline repo
baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/
gpgcheck=1
enabled=0
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
```
```
ansible all -i inventory -m copy -a "src=./nginx.repo dest=/etc/yum.repo.d/nginx.repo"
```
- copy 前，在被管理节点上对原文件进行备份 (管理节点原文件变化时，被管理节点之前的文件能保存下来)
```
ansible all -i inventory.yml -m copy -a "src=./nginx.repo dest=/etc/yum.repos.d/nginx.repo backup =yes"
```

### 4.4 yum_repsitory

添加yum仓库
**常用参数**
- `name`仓库名称，就是仓库文件中第一行中括号中的名称，**必须的参数**
- `description`仓库描述信息，添加时**必须的参数**
- `baseurl`yum存储库"repodate"目录所在的URL，添加时必须的参数。也可以是多个URL
的列表
- `file`仓库文件保存到被管理节点的文件名，不包含`.repo`。默认是`name`的值。
- `state`：preset确认添加仓库文件，absent确认删除仓库文件。
- `gpgcheck`是否检查GPG yes|no 。如果没有默认值，使用`/etc/yum.conf`中的配置

#### Example
- 添加nginx的repo原
> 官网信息
Install the prerequisites:
`sudo yum install yum-utils`
To set up the yum repository, create the file named /etc/yum.repos.d/nginx.repo with the following contents:
```
[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
```
使用ansible
```
ansible webservers -i inventory.ini -m yum_repository -a "name=nginx baseurl='http://nginx.org/packages/centos/$releasever/$basearch/' description='EPEL YUM repo'"
```

- 删除repo(必须是ansible添加的)
输入要删除的repo的name并把state改成absent即可
```
ansible webservers -i inventory.ini -m yum_repository -a "name=nginx state=absent"
```


### 4.5 yum 模块
等于在Linux上的yum命令，对远程服务器上RPM包进行管理。
**常用参数**：
- name 要安装的软件包名，多个软件包以逗号(,)隔开
- state 对当前指定的软件安装、移除操作(present installed latest absent removed)
 
  - 支持的参数
    - present 确认已经安装，但不升级
    - installed 确认已经安装
    - latest 确保安装，且升级为最新
    - absent 和 removed 确认已经移除
#### Example
- 安装一个软件包
`ansible all -i inventory.yml -m yum -a "name=nginx state=present"`

### 4.5 systemd模块

> CentOS6之前的版本使用`service`模块。
> 请使用`ansible-doc service`命令自行查看信息
管理远程节点上的systemd服务，就是由systemd所管理的服务。
#### 常用参数：
- daemon_reload 重新载入systemd，扫描新的或有变动的单元
- enabled 是否开机自启动yes|no
- name 必选项，服务名称，比如httpd,vsftpd
- state 对当前服务执行started（启动），stopped（停止），restarted（重启),reloaded(重新加载)等操作。

#### Example
- 重新加载 systemd
`ansible all -i inventory.yml -m systemd -a "daemon_reload=yes"`
- 启动Nginx服务
`ansible all -i inventory.yml -m systemd -a "name=nginx state=started"`
- 关闭Nginx服务
`ansible all -i inventory.yml -m systemd -a "name=nginx state=stopped"`
- 重启Nginx服务
`ansible all -i inventory.yml -m systemd -a "name=nginx state=restarted"`
- 重新加载Nginx服务
`ansible all -i inventory.yml -m systemd -a "name=nginx state=reloaded"`
- 将Nginx服务设置为开机自启动
`ansible all -i inventory.yml -m systemd -a "name=nginx enabled=yes"`
